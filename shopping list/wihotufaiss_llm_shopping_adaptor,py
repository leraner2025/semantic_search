# shopping_adaptor.py

import json
from google.cloud import storage
from vertexai.preview.language_models import TextGenerationModel

class MedicalAdapter:
    def __init__(self, bucket_name: str, file_path: str):
        self.bucket_name = bucket_name
        self.file_path = file_path
        self.llm = TextGenerationModel.from_pretrained("gemini-pro")
        self.topics = self._load_topics_from_gcs()

    def _load_topics_from_gcs(self):
        client = storage.Client()
        bucket = client.bucket(self.bucket_name)
        blob = bucket.blob(self.file_path)
        content = blob.download_as_text()
        return json.loads(content)

    def _generate_answer(self, query: str) -> str:
        context = "\n".join([t["chunk"] for t in self.topics])
        prompt = f"""
You are a medical assistant. Based on the following patient history, answer the question.

Patient History:
{context}

Question:
{query}

Answer:
"""
        response = self.llm.predict(prompt, temperature=0.3, max_output_tokens=400)
        return response.text.strip()

    def answer_query(self, query: str) -> dict:
        answer = self._generate_answer(query)
        return {
            "query": query,
            "answer": answer
        }
