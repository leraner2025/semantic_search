# shopping_adaptor.py

import json
from google.cloud import storage
from vertexai.preview.language_models import TextGenerationModel

class MedicalAdapter:
    def __init__(self, bucket_name: str, file_path: str):
        self.bucket_name = bucket_name
        self.file_path = file_path
        self.llm = TextGenerationModel.from_pretrained("gemini-pro")
        self.topics = self._load_topics_from_gcs()

    def _load_topics_from_gcs(self):
        client = storage.Client()
        bucket = client.bucket(self.bucket_name)
        blob = bucket.blob(self.file_path)
        content = blob.download_as_text()
        return json.loads(content)

    def _extract_intent_entities(self, query: str) -> dict:
        prompt = f"""
You are a medical assistant. Analyze the following question and extract:
1. Intent (e.g., get_test_results, get_admission_date, get_medication_history)
2. Entities (e.g., MRI, warfarin, liver enzymes)

Question: {query}

Respond in JSON format:
{{"intent": "...", "entities": ["..."]}}
"""
        response = self.llm.predict(prompt, temperature=0.2, max_output_tokens=200)
        try:
            return json.loads(response.text)
        except:
            return {"intent": "", "entities": []}

    def _generate_answer(self, query: str, intent: str, entities: list) -> str:
        context = "\n".join([t["chunk"] for t in self.topics])
        prompt = f"""
You are a medical assistant. Based on the following patient history, answer the question.

Intent: {intent}
Entities: {', '.join(entities)}

Patient History:
{context}

Question:
{query}

Answer:
"""
        response = self.llm.predict(prompt, temperature=0.3, max_output_tokens=400)
        return response.text.strip()

    def answer_query(self, query: str) -> dict:
        meta = self._extract_intent_entities(query)
        answer = self._generate_answer(query, meta["intent"], meta["entities"])
        return {
            "query": query,
            "intent": meta["intent"],
            "entities": meta["entities"],
            "answer": answer
        }


from shopping_adaptor import MedicalAdapter

adapter = MedicalAdapter(bucket_name="your-bucket-name", file_path="path/to/topics.json")
response = adapter.answer_query("What medications were prescribed after the MRI?")

print("Answer:", response["answer"])
print("Intent:", response["intent"])
print("Entities:", response["entities"])
