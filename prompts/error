import json
import re
from google import genai
from google.genai import types
from datetime import datetime

# ==================================================
# Prompts
# ==================================================

QUERY_EXPANSION_PROMPT = """
SYSTEM INSTRUCTION:
You are a highly advanced medical AI assistant specialized in **user-personalized, context-aware query expansion**. Your task is to enhance queries from a **specific user**, considering **all previous interactions from that user**, expanding medical abbreviations, and inferring missing context to produce the most precise and complete **Expanded_Query**.

---

### GUIDELINES:

1. **User-Specific Contextual Integration**
- Always integrate **all previous queries from the same user** identified by `User ID`.
- Ignore queries from other users.
- Detect and apply the user’s **preferred terminology, phrasing, and style**.
- Infer missing entities, labs, procedures, vitals, medications, imaging, or timeframes based on the user’s history.

2. **Abbreviation and Acronym Expansion**
- Expand abbreviations contextually and accurately (e.g., BP → Blood Pressure, CT → Computed Tomography).
- Match the user’s phrasing and style wherever possible.

3. **Query Enhancement and Personalization**
- Maintain the original intent while improving specificity and clarity.
- Combine multiple entities into a single, natural-language query.
- Include inferred labs, vitals, imaging, or procedures if suggested by previous queries.
- Preserve the user’s style (casual, formal, numeric, short form, etc.).

4. **Robustness Rules**
- Handle multi-entity, vague, and abbreviation-heavy queries simultaneously.
- Avoid introducing unrelated or unsupported concepts.
- Never include patient-identifying information.
- Always return strictly structured JSON.

---

User ID: {user_id}
Previous Queries: {previous_queries}
Current Query: {query}

Return ONLY a JSON object like:
{{
    "Expanded_Query": "string"
}}
"""

INTENT_ENTITY_PROMPT = """
You are an advanced clinical AI assistant specializing in:
- Intent classification (50–100+ intents)
- Entity extraction with mapping to human-readable related entities from standard medical ontologies
- Temporal interpretation
- Clinical relevance filtering
- Structured JSON output
- Safe, de-identified responses

Datetime: {datetime}
Expanded Query: {expanded_query}

Guidelines:

1. Only process patient-specific medical queries. Reject non-medical, political, or general queries.
2. Use the high-level intent set below. For ambiguous queries, set intent to "unknown or general".
3. Map entities to relevant human-readable concepts using standard ontologies.
4. Interpret temporal expressions (explicit dates, relative times, ranges, recurring patterns, physiologic events, pregnancy timelines, event-based, vague, streaming).
5. Preserve the original meaning in "formatted_query" while removing non-medical or irrelevant content.
6. Always return structured, de-identified JSON. Never include patient identifiers.

Rules:

- Clinical Relevance Rule: If query is non-medical, output:
{{
 "intent": "unknown or general",
 "entities": [],
 "formatted_query": "non-medical"
}}

- Mixed Queries Rule: Extract only medically relevant portions.
- Intent Ambiguity Rule: If primary intent is unclear, use "unknown or general".
- Entity Ambiguity Rule: Pick the most clinically relevant human-readable concept; do not invent new entities.
- Temporal Rule: Convert explicit dates to ISO 8601; leave vague dates empty.
- Always include fields: intent, entities (array), formatted_query.

High-Level Intents:

RetrieveLabResults, CompareLabResults, TrendLabResults, SummarizeLabResults, AlertAbnormalLabs,  
RetrieveImaging, CompareImaging, TrendImagingFindings, SummarizeImaging, AlertNewImaging,  
RetrieveVitalSigns, TrendVitalSigns, CompareVitalSigns, AlertAbnormalVitals,  
RetrieveMedications, SummarizeMedications, AlertNewMedications, CompareMedications,  
RetrieveAllergies, AlertNewAllergies, RetrieveClinicalNotes, SummarizeClinicalNotes,  
RetrieveDiagnoses, CompareDiagnoses, TrendDiagnoses, RetrieveProcedures, SummarizeProcedures,  
RetrieveImmunizations, RetrieveEncounters, RetrieveHospitalizations, RetrieveCarePlans,  
RetrieveCareTeam, RetrieveDeviceData, RetrieveWearableData, RetrieveGenomicData,  
RetrieveFamilyHistory, RetrieveSocialHistory, RetrieveNutritionData, RetrieveTelehealthData,  
RetrieveFunctionalStatus, RetrieveRiskScores, SummarizeRiskScores, AlertHighRisk,  
RetrieveFrailtyScores, RetrievePainScores, RetrieveSubstanceUse, RetrieveSleepData,  
RetrieveFitnessMetrics, RetrieveCognitiveStatus, RetrieveEnvironmentalExposures,  
RetrieveMaternalFetalData, RetrieveWoundCareData, RetrieveIVInfusionData, RetrieveMonitoringAlerts,  
RetrieveAdherence, ListRecentEncounters, RetrieveTumorBoardNotes, unknown or general

Entity Mapping Table:

| Entity Type            | Standard Ontology                  |
|------------------------|-----------------------------------|
| Lab / Observation      | LOINC                             |
| Diagnosis / Condition  | SNOMED CT / ICD-10                |
| Medication / Drug      | RxNorm                             |
| Allergy / Adverse Rxn  | MedDRA / SNOMED CT                |
| Procedure / Intervention| SNOMED CT / CPT                   |
| Imaging / Radiology    | LOINC / DICOM                      |
| Device / Wearable      | SNOMED CT / FDA Device Codes      |
| Genomics / Molecular   | HGNC / ClinVar / NCBI RefSeq      |
| Social Determinant     | ICD-10 Z codes / SNOMED CT        |
| Functional Status      | SNOMED CT / FHIR Observation      |
| Nutrition / Metabolic  | LOINC / SNOMED CT                  |
| Telehealth / Remote Monitoring | SNOMED CT / FHIR Observation |

Output JSON Schema:

{{
  "intent": "string",
  "entities": [
    {{
      "name": "string",
      "category": "string",
      "related_entity": "string",
      "timeframe": "string"
    }}
  ],
  "formatted_query": "string"
}}
"""

SUMMARY_PROMPT = """
You are an advanced clinical AI assistant tasked with producing concise, structured medical summaries.

Input Query / Formatted Query: {formatted_query}

Guidelines:
1. Summarize the clinical content accurately and concisely.
2. Maintain clinical relevance; do not add unrelated or speculative information.
3. Preserve any temporal context (dates, ranges, relative times) present in the query.
4. Never include patient identifiers or PHI.
5. Return only JSON in the following format.

Output JSON:
{{
  "summary": "string"
}}
"""

# ==================================================
# Smart Medical Pipeline
# ==================================================

class SmartMedicalPipeline:
    def __init__(self, project_id: str, location: str = "us-central1", model_name: str = "gemini-2.5-flash"):
        self.client = genai.Client(vertexai=True, project=project_id, location=location)
        self.model_name = model_name
        self.user_query_history = {}
        self.MAX_HISTORY = 20

    def _call_model(self, prompt: str) -> str:
        part = types.Part(text=prompt)
        contents = [types.Content(role="user", parts=[part])]
        config = types.GenerateContentConfig(
            temperature=0.0,
            max_output_tokens=2048
        )
        response = self.client.models.generate_content(
            model=self.model_name,
            contents=contents,
            config=config
        )
        return response.text.strip()

    def _extract_json(self, text: str) -> dict:
        """Safely extract JSON from LLM output."""
    # First try the whole text
        try:
            return json.loads(text)
        except json.JSONDecodeError:
            # Fallback: search for first {...} block
            try:
                match = re.search(r'\{.*\}', text, re.DOTALL)
                if match:
                    return json.loads(match.group(0))
            except json.JSONDecodeError:
                return {}
        return {}

    def expand_query(self, user_id: str, query: str) -> str:
        history = self.user_query_history.get(user_id, [])[-self.MAX_HISTORY:]
        prompt = QUERY_EXPANSION_PROMPT.format(
            user_id=user_id,
            previous_queries=history,
            query=query
        )
        output = self._call_model(prompt)
        data = self._extract_json(output)
        expanded_query = data.get("Expanded_Query", query)
        self.user_query_history.setdefault(user_id, []).append(query)
        return expanded_query

    def extract_intents_entities(self, expanded_query: str) -> dict:
        prompt = INTENT_ENTITY_PROMPT.format(
            datetime=datetime.utcnow().isoformat(),
            expanded_query=expanded_query
        )
        output = self._call_model(prompt)
        data = self._extract_json(output)
        return {
            "intent": data.get("intent", "unknown"),
            "entities": data.get("entities", []),
            "formatted_query": data.get("formatted_query", expanded_query)
        }

    def summarize_query(self, formatted_query: str) -> str:
        prompt = SUMMARY_PROMPT.format(formatted_query=formatted_query)
        output = self._call_model(prompt)
        data = self._extract_json(output)
        return data.get("summary", "")

    def run_pipeline(self, user_id: str, query: str) -> dict:
        expanded_query = self.expand_query(user_id, query)
        extraction = self.extract_intents_entities(expanded_query)
        summary = self.summarize_query(extraction["formatted_query"])

        # Print step-by-step outputs
        print("\n=== Expanded Query ===")
        print(expanded_query)
        print("\n=== Intents & Entities ===")
        print("Intent:", extraction["intent"])
        print("Entities:", extraction["entities"])
        print("Formatted Query:", extraction["formatted_query"])
        print("\n=== Summary ===")
        print(summary)

        return {
            "original_query": query,
            "expanded_query": expanded_query,
            "intent": extraction["intent"],
            "entities": extraction["entities"],
            "formatted_query": extraction["formatted_query"],
            "summary": summary
        }

# ==================================================
# Example Usage
# ==================================================
if __name__ == "__main__":
    PROJECT_ID = PROJECT_ID  # <-- Replace with your project
    pipeline = SmartMedicalPipeline(project_id=PROJECT_ID, location="us-central1")

    query = "get bp and labs for last 6 months"
    pipeline.run_pipeline("user42", query)
